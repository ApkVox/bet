const NBA_LOGOS = {
    "Atlanta Hawks": "https://cdn.nba.com/logos/nba/1610612737/global/L/logo.svg",
    "Boston Celtics": "https://cdn.nba.com/logos/nba/1610612738/global/L/logo.svg",
    "Brooklyn Nets": "https://cdn.nba.com/logos/nba/1610612751/global/L/logo.svg",
    "Charlotte Hornets": "https://cdn.nba.com/logos/nba/1610612766/global/L/logo.svg",
    "Chicago Bulls": "https://cdn.nba.com/logos/nba/1610612741/global/L/logo.svg",
    "Cleveland Cavaliers": "https://cdn.nba.com/logos/nba/1610612739/global/L/logo.svg",
    "Dallas Mavericks": "https://cdn.nba.com/logos/nba/1610612742/global/L/logo.svg",
    "Denver Nuggets": "https://cdn.nba.com/logos/nba/1610612743/global/L/logo.svg",
    "Detroit Pistons": "https://cdn.nba.com/logos/nba/1610612765/global/L/logo.svg",
    "Golden State Warriors": "https://cdn.nba.com/logos/nba/1610612744/global/L/logo.svg",
    "Houston Rockets": "https://cdn.nba.com/logos/nba/1610612745/global/L/logo.svg",
    "Indiana Pacers": "https://cdn.nba.com/logos/nba/1610612754/global/L/logo.svg",
    "LA Clippers": "https://cdn.nba.com/logos/nba/1610612746/global/L/logo.svg",
    "Los Angeles Lakers": "https://cdn.nba.com/logos/nba/1610612747/global/L/logo.svg",
    "Memphis Grizzlies": "https://cdn.nba.com/logos/nba/1610612763/global/L/logo.svg",
    "Miami Heat": "https://cdn.nba.com/logos/nba/1610612748/global/L/logo.svg",
    "Milwaukee Bucks": "https://cdn.nba.com/logos/nba/1610612749/global/L/logo.svg",
    "Minnesota Timberwolves": "https://cdn.nba.com/logos/nba/1610612750/global/L/logo.svg",
    "New Orleans Pelicans": "https://cdn.nba.com/logos/nba/1610612740/global/L/logo.svg",
    "New York Knicks": "https://cdn.nba.com/logos/nba/1610612752/global/L/logo.svg",
    "Oklahoma City Thunder": "https://cdn.nba.com/logos/nba/1610612760/global/L/logo.svg",
    "Orlando Magic": "https://cdn.nba.com/logos/nba/1610612753/global/L/logo.svg",
    "Philadelphia 76ers": "https://cdn.nba.com/logos/nba/1610612755/global/L/logo.svg",
    "Phoenix Suns": "https://cdn.nba.com/logos/nba/1610612756/global/L/logo.svg",
    "Portland Trail Blazers": "https://cdn.nba.com/logos/nba/1610612757/global/L/logo.svg",
    "Sacramento Kings": "https://cdn.nba.com/logos/nba/1610612758/global/L/logo.svg",
    "San Antonio Spurs": "https://cdn.nba.com/logos/nba/1610612759/global/L/logo.svg",
    "Toronto Raptors": "https://cdn.nba.com/logos/nba/1610612761/global/L/logo.svg",
    "Utah Jazz": "https://cdn.nba.com/logos/nba/1610612762/global/L/logo.svg",
    "Washington Wizards": "https://cdn.nba.com/logos/nba/1610612764/global/L/logo.svg"
};

const PL_LOGOS = {
    "Arsenal": "https://resources.premierleague.com/premierleague/badges/50/t3.png",
    "Aston Villa": "https://resources.premierleague.com/premierleague/badges/50/t7.png",
    "AFC Bournemouth": "https://resources.premierleague.com/premierleague/badges/50/t91.png",
    "Bournemouth": "https://resources.premierleague.com/premierleague/badges/50/t91.png",
    "Brentford": "https://resources.premierleague.com/premierleague/badges/50/t94.png",
    "Brighton & Hove Albion": "https://resources.premierleague.com/premierleague/badges/50/t36.png",
    "Brighton": "https://resources.premierleague.com/premierleague/badges/50/t36.png",
    "Burnley": "https://resources.premierleague.com/premierleague/badges/50/t90.png",
    "Chelsea": "https://resources.premierleague.com/premierleague/badges/50/t8.png",
    "Crystal Palace": "https://resources.premierleague.com/premierleague/badges/50/t31.png",
    "Everton": "https://resources.premierleague.com/premierleague/badges/50/t11.png",
    "Fulham": "https://resources.premierleague.com/premierleague/badges/50/t54.png",
    "Ipswich Town": "https://resources.premierleague.com/premierleague/badges/50/t40.png",
    "Ipswich": "https://resources.premierleague.com/premierleague/badges/50/t40.png",
    "Leicester City": "https://resources.premierleague.com/premierleague/badges/50/t13.png",
    "Leicester": "https://resources.premierleague.com/premierleague/badges/50/t13.png",
    "Liverpool": "https://resources.premierleague.com/premierleague/badges/50/t14.png",
    "Manchester City": "https://resources.premierleague.com/premierleague/badges/50/t43.png",
    "Man City": "https://resources.premierleague.com/premierleague/badges/50/t43.png",
    "Manchester United": "https://resources.premierleague.com/premierleague/badges/50/t1.png",
    "Man United": "https://resources.premierleague.com/premierleague/badges/50/t1.png",
    "Newcastle United": "https://resources.premierleague.com/premierleague/badges/50/t4.png",
    "Newcastle": "https://resources.premierleague.com/premierleague/badges/50/t4.png",
    "Nottingham Forest": "https://resources.premierleague.com/premierleague/badges/50/t17.png",
    "Nott'm Forest": "https://resources.premierleague.com/premierleague/badges/50/t17.png",
    "Southampton": "https://resources.premierleague.com/premierleague/badges/50/t20.png",
    "Tottenham Hotspur": "https://resources.premierleague.com/premierleague/badges/50/t6.png",
    "Tottenham": "https://resources.premierleague.com/premierleague/badges/50/t6.png",
    "West Ham United": "https://resources.premierleague.com/premierleague/badges/50/t21.png",
    "West Ham": "https://resources.premierleague.com/premierleague/badges/50/t21.png",
    "Wolverhampton Wanderers": "https://resources.premierleague.com/premierleague/badges/50/t39.png",
    "Wolves": "https://resources.premierleague.com/premierleague/badges/50/t39.png"
};

// Theme
const themeToggle = document.getElementById('themeToggle');
const mobileThemeToggle = document.getElementById('mobileThemeToggle');
const mobileThemeIcon = document.getElementById('mobileThemeIcon');

function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
    const icon = theme === 'dark' ? '\u2600\uFE0F' : '\u263E';
    if (themeToggle) themeToggle.textContent = icon;
    if (mobileThemeIcon) mobileThemeIcon.textContent = icon;
}

function initTheme() {
    const saved = localStorage.getItem('theme');
    if (saved) setTheme(saved);
    else setTheme('dark');
}

function toggleTheme() {
    const current = document.documentElement.getAttribute('data-theme');
    setTheme(current === 'dark' ? 'light' : 'dark');
}

if (themeToggle) themeToggle.addEventListener('click', toggleTheme);
if (mobileThemeToggle) mobileThemeToggle.addEventListener('click', toggleTheme);
initTheme();

// Navigation
function switchSection(sectionId) {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.mobile-nav-btn').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));

    document.querySelector(`.nav-tab[data-section="${sectionId}"]`)?.classList.add('active');
    document.querySelector(`.mobile-nav-btn[data-section="${sectionId}"]`)?.classList.add('active');
    document.getElementById(sectionId)?.classList.add('active');
}

document.querySelectorAll('.nav-tab, .mobile-nav-btn[data-section]').forEach(btn => {
    btn.addEventListener('click', () => {
        if (btn.dataset.section) switchSection(btn.dataset.section);
    });
});

// Toast
function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    if (!container) return;
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `<span>${type === 'success' ? '\u2705' : type === 'error' ? '\u26A0\uFE0F' : '\u2139\uFE0F'}</span><span>${message}</span>`;
    container.appendChild(toast);
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(20px)';
        toast.style.transition = 'all 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Skeleton loaders
function renderSkeletonCards(count) {
    return Array(count).fill(0).map(() => `
        <div class="prediction-card" style="pointer-events:none;">
            <div style="display:flex;align-items:center;gap:6px;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border);">
                <div class="skeleton" style="width:16px;height:16px;border-radius:50%;"></div>
                <div class="skeleton" style="width:100px;height:12px;"></div>
            </div>
            <div class="match-header">
                <div class="team">
                    <div class="skeleton" style="width:56px;height:56px;border-radius:50%;"></div>
                    <div class="skeleton" style="width:70px;height:14px;margin-top:8px;"></div>
                </div>
                <div class="skeleton" style="width:32px;height:24px;border-radius:99px;"></div>
                <div class="team">
                    <div class="skeleton" style="width:56px;height:56px;border-radius:50%;"></div>
                    <div class="skeleton" style="width:70px;height:14px;margin-top:8px;"></div>
                </div>
            </div>
            <div class="skeleton" style="width:100%;height:70px;margin-top:16px;"></div>
            <div class="skeleton" style="width:100%;height:44px;margin-top:12px;"></div>
        </div>
    `).join('');
}

// Data
let currentSport = 'nba';
let currentPredictions = [];
let allHistory = [];
let currentHistoryLimit = 20;

// Sport Selection
document.querySelectorAll('.sport-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        if (btn.classList.contains('active')) return;
        document.querySelectorAll('.sport-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentSport = btn.dataset.sport;
        loadPredictions();
        loadHistory();
    });
});

async function loadPredictions() {
    const grid = document.getElementById('predictionsGrid');
    grid.innerHTML = renderSkeletonCards(6);

    try {
        const endpoint = currentSport === 'football' ? '/predict-football' : '/predict-today';
        const response = await fetch(endpoint);
        if (!response.ok) throw new Error('Error de red');
        const data = await response.json();

        if (data.status === "pending_github_actions") {
            grid.innerHTML = `
                <div class="empty-state" style="grid-column: 1/-1;">
                    <div class="empty-icon">\u23F3</div>
                    <h3 style="font-weight:800;font-size:18px;margin-bottom:8px;">Calculando Predicciones</h3>
                    <p style="max-width:400px;margin:0 auto;line-height:1.6;">El motor de IA esta procesando los partidos de hoy. Regresa en unos minutos.</p>
                </div>`;
            return;
        }

        currentPredictions = data.predictions || [];
        renderPredictions(currentPredictions);
    } catch (error) {
        console.error(error);
        grid.innerHTML = `
            <div class="empty-state" style="grid-column: 1/-1;">
                <div class="empty-icon">\u26A0\uFE0F</div>
                <p>Error cargando datos</p>
            </div>`;
        showToast('Error cargando predicciones', 'error');
    }
}

async function loadHistory() {
    currentHistoryLimit = 20;
    const container = document.getElementById('historyContainer');
    container.innerHTML = `<div class="loading"><div class="spinner"></div><span>Cargando historial...</span></div>`;

    try {
        const endpoint = currentSport === 'football' ? '/history/football?days=60' : '/history/full?days=60';
        const response = await fetch(endpoint);
        if (!response.ok) throw new Error('Error al cargar historial');
        const data = await response.json();
        allHistory = data.history || [];
        renderHistory('all');
    } catch (error) {
        console.error('Error loading history:', error);
        container.innerHTML = `<div class="empty-state"><div class="empty-icon">\u26A0\uFE0F</div><p>Error cargando historial</p></div>`;
        showToast('Error cargando historial', 'error');
    }
}

function getLogoUrl(sport, team, backendLogo) {
    if (backendLogo) return backendLogo;
    if (sport === 'nba') return NBA_LOGOS[team] || '';
    return PL_LOGOS[team] || '';
}

function renderPredictions(predictions) {
    const grid = document.getElementById('predictionsGrid');
    if (!predictions.length) {
        const icon = currentSport === 'football' ? '\u26BD' : '\uD83C\uDFC0';
        grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1;"><div class="empty-icon">${icon}</div><p>No hay partidos de ${currentSport === 'football' ? 'futbol' : 'NBA'} hoy</p></div>`;
        return;
    }

    grid.innerHTML = predictions.map((pred, idx) => {
        const delay = (idx * 0.06).toFixed(2);

        if (currentSport === 'football') {
            const homeLogo = getLogoUrl('football', pred.home_team, pred.home_logo);
            const awayLogo = getLogoUrl('football', pred.away_team, pred.away_logo);
            const isHomeFavored = pred.prediction === pred.home_team || pred.prediction === '1';
            const isAwayFavored = pred.prediction === pred.away_team || pred.prediction === '2';
            const isDraw = pred.prediction === 'Draw' || pred.prediction === 'X';

            const homeProb = pred.probs?.home ? pred.probs.home : 0;
            const drawProb = pred.probs?.draw ? pred.probs.draw : 0;
            const awayProb = pred.probs?.away ? pred.probs.away : 0;
            const maxProb = Math.max(homeProb, drawProb, awayProb);

            const predLabel = isHomeFavored ? pred.home_team : isAwayFavored ? pred.away_team : 'Empate';

            return `
            <div class="prediction-card animate-in" style="animation-delay:${delay}s" onclick="showDetails(${idx})">
                <div class="card-league-badge">
                    <img src="https://media.api-sports.io/football/leagues/39.png" alt="PL" onerror="this.style.display='none'">
                    <span>Premier League</span>
                </div>
                <div class="match-header">
                    <div class="team">
                        ${homeLogo ? `<img class="team-logo" src="${homeLogo}" alt="${pred.home_team}" onerror="this.style.display='none'">` : ''}
                        <span class="team-name ${isHomeFavored ? 'favored' : ''}">${pred.home_team}</span>
                    </div>
                    <span class="vs-badge">VS</span>
                    <div class="team">
                        ${awayLogo ? `<img class="team-logo" src="${awayLogo}" alt="${pred.away_team}" onerror="this.style.display='none'">` : ''}
                        <span class="team-name ${isAwayFavored ? 'favored' : ''}">${pred.away_team}</span>
                    </div>
                </div>
                <div class="prob-bar-container">
                    <div class="prob-item ${isHomeFavored ? 'highlighted' : ''}">
                        <div class="prob-label">Local</div>
                        <div class="prob-value">${homeProb.toFixed(0)}%</div>
                        <div class="prob-bar-track"><div class="prob-bar-fill" style="width:${homeProb}%;animation-delay:${(idx * 0.06 + 0.3).toFixed(2)}s"></div></div>
                    </div>
                    <div class="prob-item ${isDraw ? 'highlighted' : ''}">
                        <div class="prob-label">Empate</div>
                        <div class="prob-value">${drawProb.toFixed(0)}%</div>
                        <div class="prob-bar-track"><div class="prob-bar-fill" style="width:${drawProb}%;animation-delay:${(idx * 0.06 + 0.4).toFixed(2)}s"></div></div>
                    </div>
                    <div class="prob-item ${isAwayFavored ? 'highlighted' : ''}">
                        <div class="prob-label">Visita</div>
                        <div class="prob-value">${awayProb.toFixed(0)}%</div>
                        <div class="prob-bar-track"><div class="prob-bar-fill" style="width:${awayProb}%;animation-delay:${(idx * 0.06 + 0.5).toFixed(2)}s"></div></div>
                    </div>
                </div>
                <div class="card-prediction-footer">
                    <span class="footer-label">Prediccion del modelo</span>
                    <span class="footer-value">${predLabel}</span>
                </div>
            </div>`;
        } else {
            return `
            <div class="prediction-card animate-in" style="animation-delay:${delay}s" onclick="showDetails(${idx})">
                <div class="card-league-badge">
                    <img src="https://cdn.nba.com/logos/nba/nba-logoman-word-white.svg" style="height:14px;opacity:0.7;filter:invert(1)" alt="NBA" onerror="this.style.display='none'">
                    <span>NBA</span>
                </div>
                <div class="match-header">
                    <div class="team">
                        <img class="team-logo" src="${NBA_LOGOS[pred.home_team] || ''}" alt="" onerror="this.style.display='none'">
                        <span class="team-name">${pred.home_team}</span>
                    </div>
                    <span class="vs-badge">VS</span>
                    <div class="team">
                        <img class="team-logo" src="${NBA_LOGOS[pred.away_team] || ''}" alt="" onerror="this.style.display='none'">
                        <span class="team-name">${pred.away_team}</span>
                    </div>
                </div>
                <div class="prediction-result">
                    <div class="predicted-winner">${pred.winner}</div>
                    <div class="probability">${pred.win_probability}%</div>
                    <div class="probability-label">Probabilidad</div>
                </div>
                <div class="prediction-meta">
                    ${pred.ev_score > 0 ? `<span class="meta-tag positive">EV +${pred.ev_score?.toFixed(1)}%</span>` : ''}
                    ${pred.warning_level === 'HIGH' ? `<span class="meta-tag negative">\u26A0\uFE0F Riesgo</span>` : ''}
                </div>
            </div>`;
        }
    }).join('');
}

function loadMoreHistory() {
    currentHistoryLimit += 20;
    const activeFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';
    renderHistory(activeFilter);
}

function renderHistory(filter) {
    const container = document.getElementById('historyContainer');
    let filtered = allHistory;
    if (filter !== 'all') {
        filtered = allHistory.filter(h => {
            const res = h.result ? h.result.toLowerCase() : 'pending';
            return res === filter;
        });
    }

    if (!filtered.length) {
        container.innerHTML = `<div class="empty-state"><div class="empty-icon">\uD83D\uDCED</div><p>No hay registros</p></div>`;
        return;
    }

    const visible = filtered.slice(0, currentHistoryLimit);
    const grouped = {};
    visible.forEach(h => {
        if (!grouped[h.date]) grouped[h.date] = [];
        grouped[h.date].push(h);
    });

    const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));
    let cardIndex = 0;

    let html = sortedDates.map(date => {
        const games = grouped[date];
        const dateObj = new Date(date + 'T12:00:00');
        const formatted = dateObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });

        return `
            <div class="history-day">
                <div class="history-day-header">${formatted}</div>
                <div class="history-cards">
                    ${games.map(h => {
            const delay = (cardIndex++ * 0.05).toFixed(2);
            let home = h.home_team;
            let away = h.away_team;

            if (!home || !away) {
                const matchName = h.match || h.match_id || '';
                if (matchName.includes(' vs ')) {
                    const teams = matchName.split(' vs ');
                    home = teams[0]?.trim() || 'Local';
                    away = teams[1]?.trim() || 'Visita';
                } else {
                    home = home || 'Local';
                    away = away || 'Visita';
                }
            }

            const winner = h.predicted_winner || h.prediction || h.winner || '-';
            const prob = h.prob_model ? (h.prob_model * 100).toFixed(0) :
                (h.probs?.home && (h.prediction === home) ? h.probs.home.toFixed(0) :
                    (h.probs?.away && (h.prediction === away) ? h.probs.away.toFixed(0) :
                        (h.probs?.draw && h.prediction === 'Draw' ? h.probs.draw.toFixed(0) :
                            (h.win_probability || h.probability || 0))));

            const homeLogo = getLogoUrl(currentSport, home, h.home_logo);
            const awayLogo = getLogoUrl(currentSport, away, h.away_logo);
            const leagueLabel = currentSport === 'football' ? 'Premier League' : 'NBA';
            const leagueLogo = currentSport === 'football'
                ? `<img src="https://media.api-sports.io/football/leagues/39.png" style="height:14px;opacity:0.7" alt="PL" onerror="this.style.display='none'">`
                : `<img src="https://cdn.nba.com/logos/nba/nba-logoman-word-white.svg" style="height:14px;opacity:0.7;filter:invert(1)" alt="NBA" onerror="this.style.display='none'">`;

            const resultClass = h.result?.toLowerCase() || 'pending';
            const resultColor = resultClass === 'win' ? 'var(--success)' : resultClass === 'loss' ? 'var(--danger)' : 'var(--accent)';

            return `
                <div class="history-card ${resultClass} animate-in" style="animation-delay:${delay}s">
                    <div class="card-league-badge">
                        ${leagueLogo}
                        <span>${leagueLabel}</span>
                    </div>
                    <div class="match-header">
                        <div class="team">
                            ${homeLogo ? `<img class="team-logo" src="${homeLogo}" alt="${home}" style="width:44px;height:44px" onerror="this.style.display='none'">` : `<div style="width:44px;height:44px;border-radius:50%;background:var(--bg-secondary);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;">${home.substring(0, 2)}</div>`}
                            <span class="team-name" style="font-size:12px">${home}</span>
                            ${h.home_score != null ? `<span style="font-size:20px;font-weight:900;margin-top:2px;">${h.home_score}</span>` : ''}
                        </div>
                        <span class="vs-badge">VS</span>
                        <div class="team">
                            ${awayLogo ? `<img class="team-logo" src="${awayLogo}" alt="${away}" style="width:44px;height:44px" onerror="this.style.display='none'">` : `<div style="width:44px;height:44px;border-radius:50%;background:var(--bg-secondary);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;">${away.substring(0, 2)}</div>`}
                            <span class="team-name" style="font-size:12px">${away}</span>
                            ${h.away_score != null ? `<span style="font-size:20px;font-weight:900;margin-top:2px;">${h.away_score}</span>` : ''}
                        </div>
                    </div>
                    <div class="prediction-result" style="background:${resultClass === 'win' ? 'var(--success-bg)' : resultClass === 'loss' ? 'var(--danger-bg)' : 'var(--bg-secondary)'}">
                        <div class="predicted-winner" style="color:${resultColor}">${winner}</div>
                        <div class="probability" style="font-size:24px">${prob}%</div>
                        <div class="probability-label">Probabilidad</div>
                    </div>
                    <div class="prediction-meta">
                        <span class="result-badge ${resultClass}">${resultClass === 'win' ? '\u2713 Ganada' : resultClass === 'loss' ? '\u2717 Perdida' : '\u23F3 Pendiente'}</span>
                        ${h.ev > 0 ? `<span class="meta-tag positive">+EV ${h.ev?.toFixed(1)}%</span>` : ''}
                    </div>
                </div>`;
        }).join('')}
                </div>
            </div>`;
    }).join('');

    if (filtered.length > currentHistoryLimit) {
        html += `<div class="load-more-container"><button class="load-more-btn" onclick="loadMoreHistory()">Ver mas partidos...</button></div>`;
    }

    container.innerHTML = html;
}

// Filters (solo botones con data-filter; el de "Actualizar marcadores" tiene su propio handler)
document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn[data-filter]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentHistoryLimit = 20;
        renderHistory(btn.dataset.filter);
    });
});

// Actualizar marcadores (PENDING -> WIN/LOSS) y recargar historial
async function refreshHistoryScores() {
    const btn = document.getElementById('btnRefreshScores');
    if (!btn) return;
    const wasDisabled = btn.disabled;
    btn.disabled = true;
    const icon = btn.querySelector('.btn-refresh-icon');
    if (icon) icon.style.animation = 'spin 0.8s linear infinite';
    showToast('Actualizando marcadores...', 'info');
    try {
        const res = await fetch('/history/refresh', { method: 'POST' });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.detail || res.statusText || 'Error al actualizar');
        const count = data.updated_count ?? 0;
        showToast(count > 0 ? `Marcadores actualizados (${count} partidos)` : 'Historial ya estaba al d√≠a', 'success');
        loadHistory();
    } catch (e) {
        showToast('Error al actualizar marcadores: ' + (e.message || 'Reintenta en un momento'), 'error');
    } finally {
        btn.disabled = wasDisabled;
        if (icon) icon.style.animation = '';
    }
}
document.getElementById('btnRefreshScores')?.addEventListener('click', refreshHistoryScores);

// Modal
function showDetails(index) {
    const pred = currentPredictions[index];
    if (!pred) return;

    let summary = '';
    if (currentSport === 'football') {
        const isHome = pred.prediction === pred.home_team || pred.prediction === '1';
        const isAway = pred.prediction === pred.away_team || pred.prediction === '2';
        const winnerLabel = isHome ? pred.home_team : isAway ? pred.away_team : 'Empate';
        const prob = isHome ? pred.probs?.home : isAway ? pred.probs?.away : pred.probs?.draw;
        summary = `<strong style="color:var(--accent);font-size:20px;">${winnerLabel}</strong><br><span style="font-size:14px;color:var(--text-secondary)">con <strong>${(prob || 0).toFixed(0)}%</strong> de probabilidad</span>`;
    } else {
        summary = `<strong style="color:var(--accent);font-size:20px;">${pred.winner}</strong><br><span style="font-size:14px;color:var(--text-secondary)">gana con <strong>${pred.win_probability}%</strong></span>`;
    }

    document.getElementById('modalTitle').textContent = `${pred.home_team} vs ${pred.away_team}`;
    document.getElementById('modalBody').innerHTML = `
        <div style="text-align:center;margin-bottom:20px;padding:20px;background:var(--bg-secondary);border-radius:var(--radius-md);">
            ${summary}
        </div>
        <p class="analysis-text">${pred.ai_analysis || 'Analisis de IA no disponible para este partido.'}</p>
    `;
    document.getElementById('modal').classList.add('active');
}

function closeModal() {
    document.getElementById('modal').classList.remove('active');
}

document.getElementById('modal').addEventListener('click', e => {
    if (e.target.id === 'modal') closeModal();
});

// Init
document.addEventListener('DOMContentLoaded', () => {
    loadPredictions();
    loadHistory();
    initTheme();
});
